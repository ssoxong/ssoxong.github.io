---
title: "Network Programming - epoll and Raw Socket"
excerpt: "NP post"

categories:
    - NetworkProgramming
tags:
  - [Network, Programming, epoll, Raw Socket]

toc: true
toc_sticky: true
 
date: 2023-06-04
last_modified_at: 2023-06-04
---

## epoll
select() 함수와 마찬가지로 다수의 fd를 관찰하며 요청이 온 fd를 발견하면 작업 수행   
리눅스에만 존재한다 

- 과정
1. epoll 객체 생성
2. epoll 객체 제어
3. 모니터링 시작
4. 조건에 맞는 fd의 I/O 수행

### epoll 객체 생성
```c
epoll_create(int size);
epoll_create1(int flags);
```
size: 관리 fd 개수
flag: EPOLL_CLOEXEC 지정시 해당 옵션이 지정된 다른 fd를 닫고 자신은 열기

### epoll 객체 제어
```c
struct epoll_event{
    int events;
    epoll_data_t data;
}
typedef union epoll_data{
    void *ptr;
    int fdl
    int u32;
    int u64;
} epoll_data_t;
```
```c
epoll_ctl(epfd, op, fd, epoll_event);
//epoll fd, 함수를 통해 하려는 작업, 모니터링 fd, epoll evnet 종류와 정보 전달
```

### epoll 모니터링
```c
epoll_wait(epfd, events, maxevents, timeout);
```

### epolltcpsrv.c

<iframe
  src="https://carbon.now.sh/embed?bg=rgba%28171%2C184%2C195%2C0%29&t=vscode&wt=none&l=auto&width=680&ds=false&dsyoff=20px&dsblur=68px&wc=true&wa=true&pv=0px&ph=0px&ln=false&fl=1&fm=Hack&fs=14px&lh=133%25&si=false&es=2x&wm=false&code=%2523include%2520%253Cstdio.h%253E%250A%2523include%2520%253Cstdlib.h%253E%250A%2523include%2520%253Csys%252Fsocket.h%253E%250A%2523include%2520%253Csys%252Ftypes.h%253E%250A%2523include%2520%253Cnetinet%252Fin.h%253E%250A%2523include%2520%253Cstring.h%253E%250A%2523include%2520%253Cunistd.h%253E%250A%2523include%2520%253Csys%252Ftime.h%253E%250A%2523include%2520%253Csys%252Fepoll.h%253E%250A%2523include%2520%253Cerrno.h%253E%250A%250A%2523define%2520MAX_EVENTS%250910%250A%250Avoid%2520errProc%28const%2520char*%29%253B%250A%250Aint%2520main%28int%2520argc%252C%2520char**%2520argv%29%250A%257B%250A%2509int%2520listenSd%252C%2520connectSd%253B%250A%2509struct%2520sockaddr_in%2520srvAddr%252C%2520clntAddr%253B%250A%2509int%2520clntAddrLen%252C%2520readLen%253B%250A%2509char%2520rBuff%255BBUFSIZ%255D%253B%250A%2509int%2520i%253B%250A%250A%2509int%2520epfd%252C%2520ready%252C%2520readfd%253B%250A%2509struct%2520epoll_event%2520ev%253B%250A%2509struct%2520epoll_event%2520events%255BMAX_EVENTS%255D%253B%250A%250A%2509if%28argc%2520%21%253D%25202%29%250A%2509%257B%250A%2509%2509printf%28%2522Usage%253A%2520%2525s%2520%255BPort%2520Number%255D%255Cn%2522%252C%2520argv%255B0%255D%29%253B%250A%2509%2509return%2520-1%253B%250A%2509%257D%250A%250A%2509printf%28%2522Server%2520start...%255Cn%2522%29%253B%250A%250A%2509%252F%252Fepoll%2520%25EC%2583%259D%25EC%2584%25B1%250A%2509epfd%2520%253D%2520epoll_create%281%29%253B%250A%2509if%28epfd%2520%253D%253D%2520-1%29%2520errProc%28%2522epoll_create%2522%29%253B%250A%250A%2509%252F%252F%25EB%2593%25A3%25EA%25B8%25B0%2520%25EC%2586%258C%25EC%25BC%2593%2520%25EC%2583%259D%25EC%2584%25B1%250A%2509listenSd%2520%253D%2520socket%28PF_INET%252C%2520SOCK_STREAM%252C%2520IPPROTO_TCP%29%253B%250A%2509if%28listenSd%2520%253D%253D%2520-1%2520%29%2520errProc%28%2522socket%2522%29%253B%250A%2509%250A%2509memset%28%2526srvAddr%252C%25200%252C%2520sizeof%28srvAddr%29%29%253B%250A%2509srvAddr.sin_addr.s_addr%2520%253D%2520htonl%28INADDR_ANY%29%253B%250A%2509srvAddr.sin_family%2520%253D%2520AF_INET%253B%250A%2509srvAddr.sin_port%2520%253D%2520htons%28atoi%28argv%255B1%255D%29%29%253B%250A%250A%2509%252F%252Fport%2520%25ED%2595%25A0%25EB%258B%25B9%250A%2509if%28bind%28listenSd%252C%2520%28struct%2520sockaddr%2520*%29%2520%2526srvAddr%252C%2520sizeof%28srvAddr%29%29%2520%253D%253D%2520-1%29%250A%2509%2509errProc%28%2522bind%2522%29%253B%250A%250A%2509%252F%252F%25EB%2593%25A3%25EA%25B8%25B0%250A%2509if%28listen%28listenSd%252C%25205%29%2520%253C%25200%29%2520errProc%28%2522listen%2522%29%253B%250A%2509%250A%250A%2509ev.events%2520%253D%2520EPOLLIN%253B%2520%252F%252F%25EC%259D%25BD%25EA%25B8%25B0%2520%25EB%258F%2599%25EC%259E%2591%250A%2509ev.data.fd%2520%253D%2520listenSd%253B%2520%252F%252F%25EB%2593%25A3%25EA%25B8%25B0%2520%25EC%2586%258C%25EC%25BC%2593%250A%250A%2509%252F%252F%25EA%25B0%259D%25EC%25B2%25B4%2520%25EC%25A0%259C%25EC%2596%25B4%250A%2509%252F%252FEPOLL_CTL_ADDL%253A%2520%25EA%25B4%2580%25EC%258B%25AC%2520%25EB%25A6%25AC%25EC%258A%25A4%25ED%258A%25B8%28epfd%29%25EC%2597%2590%2520listenSd%2520%25EB%2584%25A3%25EA%25B8%25B0%250A%2509if%28epoll_ctl%28epfd%252C%2520EPOLL_CTL_ADD%252C%2520listenSd%252C%2520%2526ev%29%2520%253D%253D%2520-1%29%250A%2509%2509errProc%28%2522epoll_ctl%2522%29%253B%250A%250A%2509clntAddrLen%2520%253D%2520sizeof%28clntAddr%29%253B%250A%250A%2509while%281%29%2520%257B%250A%2509%2509printf%28%2522Monitoring%2520...%2520%255Cn%2522%29%253B%250A%250A%2509%2509%252F%252Fepfd%25EC%2597%2590%25EC%2584%259C%2520events%25EA%25B0%2580%2520%25EC%2598%25AC%25EB%2595%258C%25EA%25B9%258C%25EC%25A7%2580%2520-1%2520%25EB%25AC%25B4%25ED%2595%259C%25EB%258C%2580%25EA%25B8%25B0%250A%2509%2509ready%2520%253D%2520epoll_wait%28epfd%252C%2520events%252C%2520MAX_EVENTS%252C%2520-1%29%253B%250A%2509%2509printf%28%2522ready%253A%2520%2525d%255Cn%2522%252C%2520ready%29%253B%250A%2509%2509%252F%252Fready%253A%2520%25EC%259D%25B4%25EB%25B2%25A4%25ED%258A%25B8%2520%25EB%25B0%259C%25EC%2583%259D%25ED%2595%259C%2520fd%2520%25EA%25B0%259C%25EC%2588%2598%250A%2509%2509if%28ready%2520%253D%253D%2520-1%29%2520%257B%250A%2509%2509%2509if%28errno%2520%253D%253D%2520EINTR%29%2520continue%253B%250A%2509%2509%2509else%2520errProc%28%2522epoll_wait%2522%29%253B%2509%2509%2509%250A%2509%2509%257D%250A%2509%2509%250A%2509%2509%252F%252F%25EC%259D%25B4%25EB%25B2%25A4%25ED%258A%25B8%2520%25EB%25B0%259C%25EC%2583%259D%25EC%258B%259C%250A%2509%2509%252F%252Fevents%2520%25EB%25B0%25B0%25EC%2597%25B4%25EC%2597%2590%25EB%258A%2594%2520ready%25EB%2590%259C%2520%25EB%25A7%258C%25ED%2581%25BC%25EC%259D%2598%2520fd%25EA%25B0%259C%25EC%2588%2598%25EA%25B0%2580%2520%25EC%2588%259C%25EC%2584%259C%25EB%258C%2580%25EB%25A1%259C%2520%25EC%25A0%2580%25EC%259E%25A5%25EB%2590%2598%25EC%2596%25B4%25EC%259E%2588%25EC%259D%258C%250A%2509%2509%252F%252F%25EB%2594%25B0%25EB%259D%25BC%25EC%2584%259C%2520for%280%7Eready-1%29%25EB%25A1%259C%2520%25EC%25A0%2591%25EA%25B7%25BC%25ED%2595%2598%25EB%258A%2594%2520%25EA%25B2%2583.%250A%2509%2509for%28i%253D0%253B%2520i%253Cready%253B%2520i%252B%252B%29%2509%257B%250A%2509%2509%2509%252F%252Flisten%2520socket%25EC%259D%25B4%25EB%25A9%25B4%2520%25EC%2583%2588%25EB%25A1%259C%25EC%259A%25B4%2520client%2520%25EC%2597%25B0%25EA%25B2%25B0%250A%2509%2509%2509printf%28%2522fd%253A%2520%2525d%255Cn%2522%252Cevents%255Bi%255D.data.fd%29%253B%250A%2509%2509%2509if%28events%255Bi%255D.data.fd%2520%253D%253D%2520listenSd%29%2520%257B%250A%2509%2509%2509%2509%250A%2509%2509%2509%2509%252F%252Fclient%2520%25EC%2597%25B0%25EA%25B2%25B0%250A%2509%2509%2509%2509connectSd%2520%253D%2520accept%28listenSd%252C%2520%28struct%2520sockaddr%2520*%29%2520%2526clntAddr%252C%2520%2526clntAddrLen%29%253B%250A%2509%2509%2509%2509if%28connectSd%2520%253D%253D%2520-1%29"  
  style="width: 796px; height: 2475px; border:0; transform: scale(1); overflow:hidden;"
sandbox="allow-scripts allow-same-origin">
</iframe>

<br>
epoll을 이용해서 thread, multiplex 없이 다중통신을 구현할 수 있다.  
하지만 epoll은 리눅스 only

## epoll mode
- Edge-triggered, 이벤트 일어나면 알리기

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/c8beb9fa-bb40-41fd-a8c0-68099a979c2e)

버퍼에 데이터 남아있어도 다시 data 채울 때까지 read하지 못한다.  
이벤트가 발생했을때 알리고, 그것을 처리하였으므로 다시 이벤트 발생까지 block되는 형식  

- Level-triggered, 무언가가 이용 가능하면 알리기
