---
title: "Network Programming - Domain Name Service(DNS)"
excerpt: "NP post"

categories:
    - NetworkProgramming
tags:
  - [Network, Programming, Domain, DNS]

toc: true
toc_sticky: true
 
date: 2023-06-05
last_modified_at: 2023-06-05
---

## How hostname resolution works

- DNS?
인터넷에 연결하기 위한 주소  
Domain(Host name) <-> IO

- getaddrinfo()
hostname을 IP로 바꿔주는 함수  
DNS 처리 API

### getaddrinfo() 실제 실행
1. www.example.com에 접속하려고 한다.
2. os는 해당 도메인의 IP가 로컬캐시에 있는지 확인한다.
3. TTL이 끝나 없으면, os는 DNS 서버에 쿼리를 보낸다.
4. DNS 서버도 해당 쿼리를 받으면 자신의 로컬캐시를 확인한다.
5. 있으면 리턴, 없으면 다른 DNA 서버에 물어보라고 한다.

### DNS Domain Hierarchy
도메인은 계층구조로 이루어져있다.  
- Root
- Top-Level Domain(TLDs): .com, .net, .edu..
- Second-Level Domain: google, example..

#### DNS Zone
비슷한 성격의 도메인들끼리 존을 이룬다.  

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/2b95df44-9056-470a-ad97-2f8d7534089b)


##### authoritative nameserver
각 존은 최소 하나의 **authoritative nameserver**를 갖고있으며, 거기서는 존에 대한 정보를 제공한다.  
이를 통해 DNS 쿼리에 대한 답을 제공한다.

또한, 모든 존을 관리하는 master server이거나 존에 대한 정보가 존재하는 slave server로 나뉜다.

## DNS Protocol

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/0a1f34d6-f5c7-42e9-b1ee-4b6f447afbc6)

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/981c088a-daac-4f21-8b65-11c27acde70e)

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/6fd9251a-f70a-4d63-9d84-c77cad2850a7)

1. DNS 서버의 IP는 기본으로 세팅되어 있다. 
2. hostname으로 root DNS query
3. 모르면 TLD DNS query (.com)
4. 또 모르면 하위 DNS query (example.com)
5. IP 받음

### DNS Response
- Question Section: client가 물어본 것
- Answer section: DNS가 해당 도메인 IP 알고있으면 IP 출력
- Authority section: 모르면 다른 DNS Server에게 물어보라고함
- Additional section: 쿼리 관련 추가적인 섹션

![image](https://github.com/ssoxong/ssoxong.github.io/assets/112956015/0e5eb341-405e-4a7b-91ca-647bc8814004)

답 찾으면 Authority Section말고 Answer section출력

### DNS message format
- header
- question
- answer (return IP)
- Authority
- Additional

#### DNS message: header
- 12바이트
- 각 16비트로 구성됨

| 필드| 설명 |
| ------ | --- |
| ID   | 16bit 식별자|
| 기타 |  |
|QDCOUNT| DNS 쿼리 개수|
|ANCOUNT| DNS 응답 개수 <br> -> 하나의 도메인이 여러 IP를 가질 수 있기 때문에|
|NSCOUNT| 레코드의 수|
| ARCOUNT   | 레코드의 수 |

- 기타 필드

| 필드    | 설명|
| --- | --- |
| QR| 1bit) 0이면 query, 1이면 response 나타내는 비트|
| Opcode  | 4bit) Query Type<br> 0이면 standary 쿼리, 1이면 reverse query (IP to name), 2면 서버 상태 요청|
| AA| 1bit) 응답이 인증된 응답인 경우 1, 인증되지 않은 경우 0|
| TC| 1bit) 메세지 축약된 형태 / TCP사용|
| RD| 1bit) 재귀 요청 / 최종 IP 얻기 위해 계속 DNS Query|
| RA| 1bit) DNS Server가 재귀 가능한지|
| Z|2bit) 사용되지 않음, 0세팅|
| RCODE   |4bit) 응답 코드로, 응답의 상태를 나타냄|

|RCODE|설명|
|---|---|
0|no error
1|format error
2|server fail
3|name error
4|not implemented
5| refused